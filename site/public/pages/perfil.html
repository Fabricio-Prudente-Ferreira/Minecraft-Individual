<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Village Craft | Perfil</title>
        <link rel="stylesheet" href="../css/style.css">
        <link rel="stylesheet" href="../css/perfil.css">
        <script src="../js/sessao.js"></script>
    </head>
    <body>
        <div class="header">
            <div class="container">
                <img src="../images/villageCraftExt.png" alt="VillageCraft">
                <div class="navbar">
                    <a href="./home.html">Home</a>
                    <a href="./chat.html">Assuntos</a>
                    <a href="./quiz.html">Quizzes</a>
                    <a href="./jogo.html">Jogo</a>
                    <a href="./perfil.html" class="pagina_atual">Perfil</a>
                    <a href="./index.html" class="exit">Sair</a>
                </div>
            </div>
        </div>
        <div class="headerTransition"></div>
        <div class="content">
            <div class="container">
                <span class="title">SEU PERFIL</span>
                <div class="box">
                    <div class="avatar" onclick="editImg()">
                        <img id='avatar' alt="avatar">
                    </div>
                    <div class="labels">
                        <label>
                            <span>Nome</span>
                            <input type="text" class="inputStyle" placeholder="Nome" value="Nome" id="inp_nome">
                        </label>
                        <label>
                            <span>Nickname</span>
                            <div class="flex">
                                <input type="text" class="inputStyle" placeholder="Nickname" value="Nick" id="inp_nick">
                                <input type="text" class="inputStyle id" placeholder="id" value="id" disabled id="inp_id">
                            </div>
                        </label>
                    </div>
                </div>
                <label>
                    <span>E-mail</span>
                    <input type="text" class="inputStyle" placeholder="E-mail" value="Address" id="inp_email">
                </label>
                <label>
                    <span>Data de Nascimento</span>
                    <input type="date" class="inputStyle" id="inp_dtNasc">
                </label>
                <label>
                    <span>Senha</span>
                    <div class="flex">
                        <input type="password" class="inputStyle" placeholder="Senha" value="Password!" disabled id="inp_senha">
                        <button onclick="editpw()" class="btnEdit"></button>
                    </div>
                </label>
                <div id="div_erro"></div>
                <button onclick="save()">Salvar Alterações</button>
            </div>
        </div>
        <div class="footerTransition"></div>
        <div class="footer">
            <div class="container">
                <div class="box">
                    <a href="./home.html" class="navigation">Home</a>
                    <a href="./chat.html" class="navigation">Assuntos</a>
                    <a href="./quiz.html" class="navigation">Quizzes</a>
                    <a href="./perfil.html" class="navigation">Perfil</a>
                </div>
                <img src="../images/villageCraft.png" alt="VillageCraft" class="footerLogo">
            </div>
        </div>
        <div class="footerCopyright">
            <span class="copyright">&copy; 2024 - Desenvolvido por Fabricio Prudente Ferreira | RA: 04241070 | 1-CCO/A | Faculdade São Paulo Tech School</span>
        </div>

        <div id="backgroundEditImg">
            <div class="editForm">
                <div class="top">
                    <span>Coloque a URL da sua foto (.png/.jpg/.gif):</span>
                    <button onclick="closeEditImg()" class="close">X</button>
                </div>
                <label>
                    <input type="text" placeholder="URL" class="inputStyle" id="inp_url">
                    <button onclick="saveImg()">Salvar Imagem</button>
                </label>
            </div>
        </div>
    </body>
</html>
<script>
    window.onload = load_user_data();

    function editImg(){
        document.getElementById('backgroundEditImg').style.display = 'flex'
    }

    function closeEditImg(){
        document.getElementById('backgroundEditImg').style.display = 'none'
    }

    function saveImg(){
        var url = inp_url.value;

        if(url.length > 250) alert('URL muito longa. Escolha outra!');
        else if(url.indexOf('.jpg') == -1 && url.indexOf('.png') == -1 && url.indexOf('.gif') == -1) alert('Imagem inválida');
        else {
            document.getElementById('backgroundEditImg').style.display = 'none'
            document.getElementById('avatar').src = inp_url.value;
        }
    }

    function save(){
        var id = inp_id.value.split('#')[1];
        var nome = inp_nome.value;
        var nick = inp_nick.value;
        var email = inp_email.value;
        var dtNasc = inp_dtNasc.value;
        var senha = inp_senha.value;
        var imgURL = document.getElementById('avatar').src;
        var textMsg = "";
        var validado = false;

        var caracteres_especiais = ['!', '?', '@', '#', '$', '%', '-', '_', '&', '*', '/'];
        var tem_caracter_especial = false;

        for(var cont = 0; cont < caracteres_especiais.length; cont++){
            if(senha.indexOf(caracteres_especiais[cont]) >= 0) tem_caracter_especial = true;
        }

        if(nome == "" || nick == "" || email == "" || dtNasc == "" || senha == "") textMsg = 'Por favor, deixe todos os campos preenchidos';
        else if(email.indexOf('@') == -1 || email.indexOf('.') == -1) textMsg = "Insira um e-mail válido";
        else if(senha.length < 7) textMsg = "Insira uma senha mais longa";
        else if(!tem_caracter_especial) textMsg = "Insira um caracter especial na sua senha";
        else {
            fetch('/usuarios/atualizar', {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idServer: id,
                    nomeServer: nome,
                    nickServer: nick,
                    emailServer: email,
                    senhaServer: senha,
                    dtNascServer: dtNasc,
                    imagemServer: imgURL
                })
            })
            .then(function(resposta){
                if(resposta.ok){
                    textMsg = "Atualizado com Sucesso!";
                    validado = true;
                    finalizarSessao(textMsg, validado);
                    resposta.json().then(json => {
                        sessionStorage.ID_USUARIO = json.id;
                        sessionStorage.NOME_USUARIO = json.nome;
                        sessionStorage.NICK_USUARIO = json.nick;
                        sessionStorage.EMAIL_USUARIO = json.email;
                        sessionStorage.IMAGEM_USUARIO = json.imagem;
                        sessionStorage.DTNASC_USUARIO = json.dtNasc;
                        sessionStorage.SENHA_USUARIO = json.senha;
                        
                        setTimeout(function () {
                            window.location = "./home.html";
                        }, 1000); // apenas para exibir o loading
                    });
                }
            })
            .catch(function(error){
                console.error(error);
            })

            return false;
        }

        finalizarSessao(textMsg, validado);
    }
</script>